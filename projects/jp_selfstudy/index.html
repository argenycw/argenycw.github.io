<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JP - Self Quiz</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
    body {
        background-color: #333;
        color: #ccc;        
    }

    .ag-section {
        margin-top: 50px;        
    }

    .ag-section button {
        min-width: 40%;
        margin-top: 3rem; 
    }

    .ag-font-large {
        font-size: 36px;
    }

    .ag-center {
        text-align: center;
    }

    .select-dropdown {
        background-color: #222;
        color: #ccc;
    }

    ul.dropdown-content.select-dropdown li span {
        color: #ccc; 
    }

    </style>    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.8.0/jszip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.8.0/xlsx.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script> 
</head>
<body>
    <div class="container ag-center">
        <div class="ag-section row">
            <!-- Japanese display mode -->
            <div class="col s6 m3 l2">
                <select id="jp-display-mode" onchange="SetJPDisplayMode(this.options[this.selectedIndex].text);">
                    <option value="Kanji Only">Kanji Only</option>
                    <option value="Hiragana Only">Hiragana Only</option>
                    <option value="Full" selected>Full</option>
                </select>
            </div>
            <!-- Japanese vocab mode -->
            <div class="col s6 m3 l2">
                <select multiple id="jp-vocab-mode" onchange="SetJPVocabMode(M.FormSelect.getInstance(this).getSelectedValues());">
                    <option value="Godan Verb" selected>Godan Verb</option>
                    <option value="Ichidan Verb" selected>Ichidan Verb</option>
                    <option value="I-Adjective">I-Adjective</option>
                    <option value="Na-Adjective">Na-Adjective</option>
                </select>
            </div>
            <!-- TODO difficulty N5-N3 -->
            <div class="col s4 m2 l1">
                <select multiple id="jp-vocab-mode" onchange="SetJPDifficulty(M.FormSelect.getInstance(this).getSelectedValues());">
                    <option value="5" selected>N5</option>
                    <option value="4" selected>N4</option>
                    <option value="3">N3</option>
                    <option value="2">N2</option>
                    <option value="1">N1</option>
                </select>
            </div>            
            <div class="col m2">Vocab Size: <span id="jp-vocab-size"></span></div>
        </div>
        <div class="ag-font-large" id="current-row"></div>
        <div class="ag-section row" id="mc-options"></div>                
        <div class="ag-section">
            <button class="btn blue-grey darken-1 waves-effect waves-light" onclick="LoadRandomRow();">Next<i class="material-icons right">send</i></button>
        </div>        
    </div>
</body>
</html>

<script>
    // Materialize init dropdown
    document.addEventListener('DOMContentLoaded', function() {
        var elems = document.querySelectorAll('select');
        var instances = M.FormSelect.init(elems, {});
    });

    // global config
    var EXCEL_NAME = "dict/vocabs.xlsx";
    var EXCEL_BLOB = null;
    var JP_DISPLAY_MODE = "Mixed";
    var JP_VOCAB_MODE = {
        'Godan Verb': true,
        'Ichidan Verb': true,
        'I-Adjective': false,
        'Na-Adjective': false,
    };
    var JP_VOCAB_DIFFICULTIES = {
        '5': true, 
        '4': true, 
        '3': false, 
        '2': false, 
        '1': false, 
    };

    // placeholder
    var vocab_rows = [];
    var current_vocab = null;

    var ReadExcelDict = function(blob, mode, difficulty) {
        var reader = new FileReader();
        var rows = null;
        var size = 0;

        reader.onload = function(e) {
            var data = e.target.result;
            var workbook = XLSX.read(data, {
                type: 'binary'
            });
            
            vocab_rows = []; // reset the vocab rows
            // get the sheet as specified by JP_VOCAB_MODE
            Object.keys(mode).forEach((k) => {
                if (mode[k]) {
                    let xl_rows_json = XLSX.utils.sheet_to_json(workbook.Sheets[k]);
                    vocab_rows.push(...xl_rows_json);
                }
            });
            // filter the vocabs with difficulties
            vocab_rows = vocab_rows.filter(vocab => {
                return difficulty[vocab["Level"]];
            });
            // TODO distinguish different type of vocabs
            UpdateVocabSize();
        };

        reader.onerror = function(ex) {
            console.error(ex);
        };

        reader.readAsBinaryString(blob);        
    };

    var FormatVocabInHTML = function(vocab_jp, format='full') {
        // process bracket
        kanji_upper_hiragana = vocab_jp.split(/\((.*)\)/);
        if (kanji_upper_hiragana.length == 3) {
            vocab_jp_kanji = kanji_upper_hiragana[0];
            vocab_jp_upper = kanji_upper_hiragana[1];
            vocab_jp_hiragana = kanji_upper_hiragana[2];
        }
        else if (kanji_upper_hiragana.length == 1) {
            vocab_jp_hiragana = kanji_upper_hiragana;
        }
        else {
            throw Error("Invalid length: ", kanji_upper_hiragana);
        }

        if (format == "Kanji Only") {
            return (
                `<ruby>${vocab_jp_kanji}${vocab_jp_hiragana}</ruby>`
            );
        } 
        else if (format == "Hiragana Only") {
            return (
                `<ruby>${vocab_jp_upper}${vocab_jp_hiragana}</ruby>`
            );
        }
        else if (format == "Full") {
            return (
                `<ruby>${vocab_jp_kanji}<rt>${vocab_jp_upper}</rt>${vocab_jp_hiragana}</ruby>`
            );
        }
        else {
            throw Error("Unsupported format: ", format);
        }  
    }

    // ============ JP display mode ============
    var UpdateDisplayMode = function() {
        if (current_vocab) {
            vocab_en = current_vocab["EN"];
            vocab_jp = current_vocab["JP"];          
            document.getElementById("current-row").innerHTML = FormatVocabInHTML(vocab_jp, JP_DISPLAY_MODE);
        }
    }

    var SetJPDisplayMode = function(displayMode="Full") {
        JP_DISPLAY_MODE = displayMode;
        UpdateDisplayMode();        
    };
    SetJPDisplayMode();
    // ============ JP vocab mode =============
    var SetJPVocabMode = function(selectedModes) {
        // unset first
        Object.keys(JP_VOCAB_MODE).forEach(k => {
            JP_VOCAB_MODE[k] = false;
        });
        // set back to true
        selectedModes.forEach(mode => {
            JP_VOCAB_MODE[mode] = true;
        });
        // reload the excel dict     
        ReadExcelDict(EXCEL_BLOB, JP_VOCAB_MODE, JP_VOCAB_DIFFICULTIES);
    }
    // ============ JP Vocab Difficulty =======
    var SetJPDifficulty = function(selectedDifficulties) {
        // unset first
        Object.keys(JP_VOCAB_DIFFICULTIES).forEach(k => {
            JP_VOCAB_DIFFICULTIES[k] = false;
        });
        // set back to true
        selectedDifficulties.forEach(n => {
            JP_VOCAB_DIFFICULTIES[n] = true;
        });
        // reload the excel dict     
        ReadExcelDict(EXCEL_BLOB, JP_VOCAB_MODE, JP_VOCAB_DIFFICULTIES);
    }
    // ============ JP vocab size =============
    var UpdateVocabSize = function() {
        if (vocab_rows && vocab_rows.length) {   
            document.getElementById("jp-vocab-size").textContent = vocab_rows.length;
        }        
    }
    // ========================================
    var UpdateOptions = function(options) {
        options.sort();
        document.getElementById("mc-options").innerHTML = `
            <div class="col s6"><button class="ans-btn btn-large blue-grey darken-1 waves-effect waves-light" data-ans="${options[0][1]}" onclick="VerifyAnswer(this);">${options[0][0]}</button></div>
            <div class="col s6"><button class="ans-btn btn-large blue-grey darken-1 waves-effect waves-light" data-ans="${options[1][1]}" onclick="VerifyAnswer(this);">${options[1][0]}</button></div>
            <div class="col s6"><button class="ans-btn btn-large blue-grey darken-1 waves-effect waves-light" data-ans="${options[2][1]}" onclick="VerifyAnswer(this);">${options[2][0]}</button></div>
            <div class="col s6"><button class="ans-btn btn-large blue-grey darken-1 waves-effect waves-light" data-ans="${options[3][1]}" onclick="VerifyAnswer(this);">${options[3][0]}</button></div>
        `;
    }

    var LoadRandomRow = function() {
        if (!vocab_rows || !vocab_rows.length) throw Error("ExcelReader is not yet ready!");
        // load a random row
        let randId = Math.floor(Math.random() * vocab_rows.length);
        current_vocab = vocab_rows[randId];
        vocab_en = current_vocab["EN"];
        vocab_jp = current_vocab["JP"];             
        UpdateDisplayMode();        

        // load 3 wrong rows
        let options = [[vocab_en, 1]]
        let vocab_rows_reduced = vocab_rows.slice(0, randId).concat(vocab_rows.slice(randId+1));        
        for (let i = 0; i < 3; i++) {
            let wrongId = Math.floor(Math.random() * vocab_rows_reduced.length);
            vocab_row = vocab_rows_reduced[wrongId]
            vocab_rows_reduced = vocab_rows_reduced.slice(0, randId).concat(vocab_rows_reduced.slice(randId+1));            
            options.push([vocab_row["EN"], 0]);
        } 
        UpdateOptions(options);
    }

    var VerifyAnswer = function(answerTag) {
        // disable all buttons
        Array.from(document.getElementsByClassName("ans-btn")).forEach(btn => {
            btn.disabled = true;
            btn.onclick = null;
            if (btn.getAttribute("data-ans") === "1") {
                btn.classList.remove("blue-grey");
                btn.classList.add("green");
                btn.disabled = false;
            }
        });
        // incorrect
        if (answerTag.getAttribute("data-ans") === "0") {
            answerTag.classList.remove("blue-grey");
            answerTag.classList.add("red");
            answerTag.disabled = false;
        }
    }

    window.onload = () => {            
        // ready dictionary
        fetch(EXCEL_NAME).then(f => f.blob()).then(blob => {
            EXCEL_BLOB = blob;
            ReadExcelDict(blob, JP_VOCAB_MODE, JP_VOCAB_DIFFICULTIES);
        });
    }
</script>   
